package Phase2;

public class Products {

	// Static AVL tree holding all products made in the system
	private static AVL<Products> products = new AVL<>();

	// Each product has its own AVL tree of reviews
	private AVL<Reviews> reviews; 

	//~~~~~~~~~~~ Attributes ~~~~~~~~~~~
	private int productId; // key of the product
	private String name; // name of the product
	private double price; // price of the product
	private int stock; // the number of this product available

	//~~~~~~~~~~~ Constructor ~~~~~~~~~~~

	public Products(int productId, String name, double price, int stock) {
		this.productId = productId;
		this.name = name;
		this.price = price;
		this.stock = stock;
		this.reviews = new AVL<>();
	}

	//~~~~~~~~~~~ Add a new product ~~~~~~~~~~~

	public static void addProducts(Products product) {
		if (products.findkey(product.getProductId()) == true) { // Check if product already exists
			System.out.println("Product already exists");
			return;
		}
		products.insert(product.getProductId(),product);
		System.out.println("Product added successfully.");
	}

	//~~~~~~~~~~~ Remove a product by ID ~~~~~~~~~~~

	public void removeProduct(int productId) {
		if (products.empty()) {
			System.out.println("No products found");
			return;
		}

		if (products.findkey(productId)) {
			products.removeKey(productId);
			System.out.println("Product removed successfully");
			return;
		}
		System.out.println("Product not found");
	}

	//~~~~~~~~~~~ Update the price and stock for a product ~~~~~~~~~~~

	public void updateProducts(int productId, double price, int stock) {
		if (!products.findkey(productId)) {
			System.out.println("No product found with that ID");
			return;
		}
		Products p = products.retrieve();
		p.setPrice(price);
		p.setStock(stock);
		System.out.println("Product updated successfully");
	}

	//~~~~~~~~~~~ Search for a product by its key ~~~~~~~~~~~

	public static Products searchById(int productID) {
		if (!products.findkey(productID))
			return null;
		return products.retrieve();
	}

	//~~~~~~~~~~~ Track out of stock products ( stock=0 ) ~~~~~~~~~~~

	public static AVL<Products> trackOutOfStock() {
		AVL<Products> outOfStock = new AVL<>();
		traverseOutOfStock(products.root, outOfStock);
		return outOfStock;
	}

	private static void traverseOutOfStock(AVLNode<Products> node, AVL<Products> outOfStock) {
		if (node == null)
			return;
		traverseOutOfStock(node.left, outOfStock);
		if (node.data.stock == 0)
			outOfStock.insert(node.data.productId, node.data);

		traverseOutOfStock(node.right, outOfStock);
	}

	//~~~~~~~~~~~ Add review ~~~~~~~~~~~

	public void addReview(Reviews review) {
		reviews.insert(review.getReviewId(), review);
	}

	//~~~~~~~~~~~ Get average rating ~~~~~~~~~~~

	public int averageRating() {
		if (reviews.empty())
			return 0;
		int[] result = averageRatingRec(reviews.root);	// To hold [sum, count]
		if (result[1] == 0) // If no reviews found (result[1] is count)
			return 0; 
		return result[0] / result[1]; // sum/count
	}

	private int[] averageRatingRec(AVLNode<Reviews> node) {
		if (node == null)
			return new int[]{0, 0};

		int[] left = averageRatingRec(node.left);
		int[] right = averageRatingRec(node.right);

		int totalSum = left[0] + right[0] + node.data.getRatingScore(); // Add current node's rating score to the sum from left and right
		int totalCount = left[1] + right[1] + 1;  // Increment count by 1 for the current node plus counts from left and right

		return new int[]{totalSum, totalCount};
	}

	//~~~~~~~~~~~ Top 3 products by average rating ~~~~~~~~~~~

	public static void printTop3() {
		if (products.empty()) {
			System.out.println("No products found.");
			return;
		}

		// To hold the top 3 products
		Products[] topProducts = new Products[3];
		traverseTop(products.root, topProducts);

		System.out.println("Top 3 products by average rating:");
		print(topProducts);
	}

	private static void traverseTop(AVLNode<Products> node, Products[] topProducts) {
		if (node == null)
			return;
		// In order traversal
		traverseTop(node.left, topProducts);
		Insert(node.data, topProducts);
		traverseTop(node.right, topProducts);
	}

	// Method to insert product into topProducts if its rating is high enough
	private static void Insert(Products p, Products[] topProducts) {
		int avg = p.averageRating();

		if (topProducts[0] == null || avg > topProducts[0].averageRating()) {
			// Shift 1st to 2nd, 2nd to 3rd, then insert new as 1st
			topProducts[2] = topProducts[1];
			topProducts[1] = topProducts[0];
			topProducts[0] = p;
		}
		else if (topProducts[1] == null || avg > topProducts[1].averageRating()) {
			// Shift 2nd to 3rd, then insert new as 2nd
			topProducts[2] = topProducts[1];
			topProducts[1] = p;
		}
		else if (topProducts[2] == null || avg > topProducts[2].averageRating()) {
			// Insert new as 3rd
			topProducts[2] = p;
		}
	}

	// Print the contents of the topProducts
	private static void print(Products[] topProducts) {
		if (topProducts[0] != null) System.out.println(topProducts[0] + " || Avg Rating: " + topProducts[0].averageRating());
		if (topProducts[1] != null) System.out.println(topProducts[1] + " || Avg Rating: " + topProducts[1].averageRating());
		if (topProducts[2] != null) System.out.println(topProducts[2] + " || Avg Rating: " + topProducts[2].averageRating());
	}

	//~~~~~~~~~~~ Range query by price ~~~~~~~~~~~

	public static AVL<Products> rangeQueryByPrice(double minPrice, double maxPrice) {
		AVL<Products> result = new AVL<>();
		rangeRec(products.root, minPrice, maxPrice, result);
		return result;
	}

	private static void rangeRec(AVLNode<Products> node, double min, double max, AVL<Products> result) {
		if (node == null) 
			return;
		rangeRec(node.left, min, max, result);
		if (node.data.price >= min && node.data.price <= max)
			result.insert(node.data.productId, node.data);

		rangeRec(node.right, min, max, result);
	}


	//~~~~~~~~~~~ ToString ~~~~~~~~~~~

	public String toString() {
		return "Product ID: " + productId + " || Name: " + name + " || Price: " + price + " || Stock: " + stock;
	}

	//~~~~~~~~~~~ Setters and getters ~~~~~~~~~~~

	public int getProductId() { 
		return productId; }

	public String getName() { 
		return name; }

	public double getPrice() { 
		return price; }

	public int getStock() { 
		return stock; }

	public void setPrice(double price) { 
		this.price = price; }

	public void setStock(int stock) { 
		this.stock = stock; }

	public AVL<Reviews> getReviewsList() { 
		return reviews; }

	public static AVL<Products> getProducts() { 
		return products; }
}
