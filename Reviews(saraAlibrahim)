package Phase2;

public class Reviews {

	// Static AVL tree holding all reviews
	private static AVL<Reviews> reviews = new AVL<>();

	// Review attributes
	private int reviewId;
	private int productId;
	private int customerId;
	private int ratingScore;
	private String textComment;

	// Constructor
	public Reviews(int reviewId, int productId, int customerId, int ratingScore, String textComment) {
		this.reviewId = reviewId;
		this.productId = productId;
		this.customerId = customerId;
		this.ratingScore = ratingScore;
		this.textComment = textComment;
	}

	//----------------------------------------------------------------------------------//
	// Add a new review to the main review AVL and the product's own review AVL

	public static boolean addReview(Reviews review) {// Time complexity: O(log n) - Space complexity: O(1)
		// Insert review into main AVL keyed by reviewId
		boolean inserted = reviews.insert(review.getReviewId(), review);
		if (inserted) {
			// Add the review to the product’s own review AVL
			Products product = Products.searchById(review.getProductId());
			if (product != null) {
				product.addReview(review);
				return true;
			}
		}
		return false;
	}

	//----------------------------------------------------------------------------------//
	// Edit a review inside both the main AVL and the product’s own AVL
	public static boolean editReview(int reviewId, int ratingScore, String textComment) { // Time complexity: O(log n) - Space complexity: O(1)
		if (reviews.empty()) { // no reviews yet
			System.out.println("Review not found");
			return false;
		}
		boolean exists = reviews.findkey(reviewId); // see if review exists
		if (!exists) {
			System.out.println("Review not found");
			return false;
		}
		Reviews review = reviews.retrieve(); // get the review to update
		review.setRatingScore(ratingScore); // update rating
		review.setTextComment(textComment); // update comment
		reviews.update(reviewId, review); // update main AVL

		// update review in the product's own list too
		Products product = Products.searchById(review.getProductId()); 
		if (product != null) {
			AVL<Reviews> productReviews = product.getReviewsList();
			if (!productReviews.empty()) {
				boolean inside = productReviews.findkey(reviewId); // check if review exists in product
				if (inside) {
					Reviews pr = productReviews.retrieve(); 
					pr.setRatingScore(ratingScore); 
					pr.setTextComment(textComment); 
					productReviews.update(reviewId, pr); // update product’s AVL
				}
			}
		}
		return true; // done updating
	}


	//----------------------------------------------------------------------------------//
	// Calculate average rating for all reviews
	static int sumRating;
	static int countRating;

	public static int averageRating() { // Time complexity: O(n) - Space complexity: O(log n)
		if (reviews.empty()) { // no reviews yet
			return 0; 
		}
		sumRating = 0; // reset sum
		countRating = 0; // reset count
		averageRatingRec(reviews.root); // traverse and update sum n count
		if (countRating > 0) { // if we have reviews
			return sumRating / countRating; // average = sum n count
		}
		return 0; 
	}
	// recursive helper 
	private static void averageRatingRec(AVLNode<Reviews> node) {
		if (node == null) // end of branch
			return; 
		averageRatingRec(node.left); // left subtree
		averageRatingRec(node.right); // right subtree
		sumRating += node.data.getRatingScore(); // add this review's rating
		countRating += 1; // increment count
	}

	//----------------------------------------------------------------------------------//
	// Display customers who reviewed a specific product 
	public static void displayCustomersWhoReviewedProduct(int productId) {// Time complexity: O(n) - Space complexity: O(log n)
		if (reviews.empty()) {
			System.out.println("No reviews found.");
			return;
		}
		System.out.println("\n--- Customers Who Reviewed Product ID " + productId + " (Sorted by Customer ID) ---");
		displayCustomersRec(reviews.root, productId);
	}
	// helper method to print sorted by customer ID
	private static void displayCustomersRec(AVLNode<Reviews> node, int productId) {
		if (node == null) {
			return;
		}
		displayCustomersRec(node.left, productId);
		if (node.data.getProductId() == productId) {
			Customers customer = Customers.searchById(node.data.getCustomerId());
			if (customer != null) {
				System.out.println(customer + " || Rating Given: " + node.data.getRatingScore());
			}
		}
		displayCustomersRec(node.right, productId);
	}

	//----------------------------------------------------------------------------------//
	public String toString() {
		return "Review ID: " + reviewId + " || Product ID: " + productId + " || Customer ID: " + customerId + " || Rating: " + ratingScore + " || Comment: " + textComment;
	}

	// Setters and getters
	public int getReviewId() { 
		return reviewId; }
	public int getProductId() { 
		return productId; }
	public int getCustomerId() { 
		return customerId; }
	public int getRatingScore() {
		return ratingScore; }
	public String getTextComment() { 
		return textComment; }
	public void setRatingScore(int ratingScore) { 
		this.ratingScore = ratingScore; }
	public void setTextComment(String textComment) {
		this.textComment = textComment; }
	public static AVL<Reviews> getReviews() { 
		return reviews; }
}
