package Phase2;

public class Reviews {

	// Static AVL tree holding all reviews
	private static AVL<Reviews> reviews = new AVL<>();

	//~~~~~~~~~~~ Attributes ~~~~~~~~~~~
	private int reviewId;
	private int productId;
	private int customerId;
	private int ratingScore;
	private String textComment;
	static int sumRating;
	static int countRating;

	//~~~~~~~~~~~ Constructor ~~~~~~~~~~~
	public Reviews(int reviewId, int productId, int customerId, int ratingScore, String textComment) {
		this.reviewId = reviewId;
		this.productId = productId;
		this.customerId = customerId;
		this.ratingScore = ratingScore;
		this.textComment = textComment;
	}

	//~~~~~~~~~~~ Add a new review to the product's own review AVL tree and the static AVL tree ~~~~~~~~~~~

	public static boolean addReview(Reviews review) {
		// Insert review into main AVL keyed by reviewId
		boolean inserted = reviews.insert(review.getReviewId(), review);
		if (inserted) {
			// Add the review to the product’s own review AVL
			Products product = Products.searchById(review.getProductId());
			if (product != null) {
				product.addReview(review);
				return true;
			}
		}
		return false;
	}

	//~~~~~~~~~~~ Edit a review inside both the main AVL and the product’s own AVL ~~~~~~~~~~~
	
	public static boolean editReview(int reviewId, int ratingScore, String textComment) {
		if (reviews.empty()) { // No reviews yet
			System.out.println("Review not found");
			return false;
		}
		boolean exists = reviews.findkey(reviewId); // Check if reviews exists
		if (!exists) {
			System.out.println("Review not found");
			return false;
		}
		Reviews review = reviews.retrieve();
		review.setRatingScore(ratingScore); // Update rating
		review.setTextComment(textComment); // update comment
		reviews.update(reviewId, review); // Update static AVL

		// Update review in the product's own list too
		Products product = Products.searchById(review.getProductId()); 
		if (product != null) {
			AVL<Reviews> productReviews = product.getReviewsList();
			if (!productReviews.empty()) {
				boolean inside = productReviews.findkey(reviewId); // Check if review exists in product
				if (inside) {
					Reviews pr = productReviews.retrieve(); 
					pr.setRatingScore(ratingScore); 
					pr.setTextComment(textComment); 
					productReviews.update(reviewId, pr); // Update product’s AVL
				}
			}
		}
		return true;
	}

	//~~~~~~~~~~~ Calculate average rating for all reviews ~~~~~~~~~~~

	public static int averageRating() { 
		if (reviews.empty()) { // No reviews yet
			return 0; 
		}
		sumRating = 0; // Reset sum
		countRating = 0; // Reset count
		averageRatingRec(reviews.root); // traverse and update sum and count
		if (countRating > 0) { // if we have reviews
			return sumRating / countRating; // average = sum / count
		}
		return 0; 
	}
	// recursive method to calculate the average rating 
	private static void averageRatingRec(AVLNode<Reviews> node) {
		if (node == null) // Reached the end of the subtree
			return; 
		averageRatingRec(node.left); // Left subtree
		averageRatingRec(node.right); // Right subtree
		sumRating += node.data.getRatingScore(); // Add the review's rating
		countRating += 1; // Increment count by one
	}

	//~~~~~~~~~~~ Display customers who reviewed a specific product  ~~~~~~~~~~~
	
	public static void displayCustomersWhoReviewedProduct(int productId) {
		if (reviews.empty()) {
			System.out.println("No reviews found.");
			return;
		}
		System.out.println("\n--- Customers Who Reviewed Product ID " + productId + " (Sorted by Customer ID) ---");
		displayCustomersRec(reviews.root, productId);
	}
	// Recursive method to print the customers (sorted by customer ID)
	private static void displayCustomersRec(AVLNode<Reviews> node, int productId) {
		if (node == null) {
			return;
		}
		displayCustomersRec(node.left, productId);
		if (node.data.getProductId() == productId) {
			Customers customer = Customers.searchById(node.data.getCustomerId());
			if (customer != null) {
				System.out.println(customer + " || Rating Given: " + node.data.getRatingScore());
			}
		}
		displayCustomersRec(node.right, productId);
	}

	//~~~~~~~~~~~ ToString ~~~~~~~~~~~
	
	public String toString() {
		return "Review ID: " + reviewId + " || Product ID: " + productId + " || Customer ID: " + customerId + " || Rating: " + ratingScore + " || Comment: " + textComment;
	}

	//~~~~~~~~~~~ Setters and getters ~~~~~~~~~~~
	
	public int getReviewId() { 
		return reviewId; }
	
	public int getProductId() { 
		return productId; }
	
	public int getCustomerId() { 
		return customerId; }
	
	public int getRatingScore() {
		return ratingScore; }
	
	public String getTextComment() { 
		return textComment; }
	
	public void setRatingScore(int ratingScore) { 
		this.ratingScore = ratingScore; }
	
	public void setTextComment(String textComment) {
		this.textComment = textComment; }
	
	public static AVL<Reviews> getReviews() { 
		return reviews; }
}
