package Phase2;

public class Reviews {

	// Static AVL tree holding all reviews
	private static AVL<Reviews> reviews = new AVL<>();

	// Review attributes
	private int reviewId;
	private int productId;
	private int customerId;
	private int ratingScore;
	private String textComment;

	// Constructor
	public Reviews(int reviewId, int productId, int customerId, int ratingScore, String textComment) {
		this.reviewId = reviewId;
		this.productId = productId;
		this.customerId = customerId;
		this.ratingScore = ratingScore;
		this.textComment = textComment;
	}

	//----------------------------------------------------------------------------------//
	// Add a new review to the main review list and the product's own review list

	public static boolean addReview(Reviews review) {
		// Insert review into main AVL keyed by reviewId
		boolean inserted = reviews.insert(review.getReviewId(), review);
		if (inserted) {
			// Add the review to the product’s own review tree
			Products product = Products.searchById(review.getProductId());
			if (product != null) {
				product.addReview(review);
				return true;
			}
		}
		return false;
	}

	//----------------------------------------------------------------------------------//
	// Edit a review inside both the main list and the product’s own list

	public static boolean editReview(int reviewId, int ratingScore, String textComment) {
		if (reviews.empty()) {
			System.out.println("Review not found");
			return false;
		}
		boolean exists = reviews.findkey(reviewId);
		if (!exists) {
			System.out.println("Review not found");
			return false;
		}
		// Retrieve the review
		Reviews review = reviews.retrieve();
		// Update review values
		review.setRatingScore(ratingScore);
		review.setTextComment(textComment);
		// Update inside main AVL
		reviews.update(reviewId, review);
		// Now update the review also inside the product's own list
		Products product = Products.searchById(review.getProductId());
		if (product != null) {
			AVL<Reviews> productReviews = product.getReviewsList();
			if (!productReviews.empty()) {
				boolean inside = productReviews.findkey(reviewId);
				if (inside) {
					Reviews pr = productReviews.retrieve();
					pr.setRatingScore(ratingScore);
					pr.setTextComment(textComment);
					productReviews.update(reviewId, pr);
				}
			}
		}
		return true;
	}

	//----------------------------------------------------------------------------------//
	// Calculate average rating for all reviews
	public static int averageRating() {
		if (reviews.empty()) {
			return 0;
		}
		int[] result = averageRatingRec(reviews.root);// result[0] = sum, result[1] = count
		if (result[1] > 0) {
			return result[0] / result[1]; 
		}
		return 0;
	}
	// helper method returns {sum, count}
	private static int[] averageRatingRec(AVLNode<Reviews> node) {
		if (node == null) {
			return new int[]{0, 0};
		}
		int[] left = averageRatingRec(node.left);
		int[] right = averageRatingRec(node.right);

		int sum = left[0] + right[0] + node.data.getRatingScore();
		int count = left[1] + right[1] + 1;

		return new int[]{sum, count};
	}


	//----------------------------------------------------------------------------------//
	// Display customers who reviewed a specific product 
	public static void displayCustomersWhoReviewedProduct(int productId) {
		if (reviews.empty()) {
			System.out.println("No reviews found.");
			return;
		}
		System.out.println("\n--- Customers Who Reviewed Product ID " + productId + " (Sorted by Customer ID) ---");
		displayCustomersRec(reviews.root, productId);
	}
	// helper method to print sorted by customer ID
	private static void displayCustomersRec(AVLNode<Reviews> node, int productId) {
		if (node == null) {
			return;
		}
		displayCustomersRec(node.left, productId);
		if (node.data.getProductId() == productId) {
			Customers customer = Customers.searchById(node.data.getCustomerId());
			if (customer != null) {
				System.out.println(customer + " || Rating Given: " + node.data.getRatingScore());
			}
		}
		displayCustomersRec(node.right, productId);
	}

	//----------------------------------------------------------------------------------//
	public String toString() {
		return "Review ID: " + reviewId 
				+ " || Product ID: " + productId 
				+ " || Customer ID: " + customerId 
				+ " || Rating: " + ratingScore 
				+ " || Comment: " + textComment;
	}

	// Setters and getters
	public int getReviewId() { 
		return reviewId; }
	public int getProductId() { 
		return productId; }
	public int getCustomerId() { 
		return customerId; }
	public int getRatingScore() {
		return ratingScore; }
	public String getTextComment() { 
		return textComment; }
	public void setRatingScore(int ratingScore) { 
		this.ratingScore = ratingScore; }
	public void setTextComment(String textComment) {
		this.textComment = textComment; }
	public static AVL<Reviews> getReviews() { 
		return reviews; }
}
